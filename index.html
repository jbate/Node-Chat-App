<html>
  <head>
  	<title>Socket.io chat form</title>
  </head>
  <body>

    <form id="setNicknameForm" style="display:none;">
    	<input name="nickname" type="text"><br />
    	<button>Set nickname</button>
    </form>

    <form id="chatForm" style="display:none;">
    	<input name="text" type="text" size="30"><br />
    	<button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Bind event listeners
        var nicknameForm = document.getElementById("setNicknameForm");
        if (nicknameForm.addEventListener) {
            nicknameForm.addEventListener('submit', setNickname, false); 
        } else if (nicknameForm.attachEvent)  {
            nicknameForm.attachEvent('onsubmit', setNickname);
        }

        var chatForm = document.getElementById("chatForm");
        if (chatForm.addEventListener) {
            chatForm.addEventListener('submit', sendChat, false);  
        } else if (chatForm.attachEvent)  {
            chatForm.attachEvent('onsubmit', sendChat);
        }

        // Open a new connection with the server
        //var socket = io.connect('http://localhost');
        var socket = io.connect();
        // When the connection is ready, show the setNickname form
        socket.on('ready', function () {
            console.log("server ready");
            if(nicknameForm) {
          	   nicknameForm.style.display = "block";
      	    }
        });

        // On receiving new messages
        socket.on('message', function (name, message) {
            console.log(name + ": " + message);
            // Highlight the user's name
            var highlight = "#3c763d;";
            if(name === "You"){
                highlight = "#999;";
            }
            // Add it to the DOM
            addMessageToPage("<strong style='color:" + highlight + "'>" + name + "</strong>: " + message);
        });

        // On a new visitor joining
        socket.on('newVisitor', function (name) {
            // Add it to the DOM
            addMessageToPage("<em>" + name + " has just joined</em>");
        });

       // Set the nickname on the server
       function setNickname(event){
        	var nickname = document.forms[0].nickname.value;
          socket.emit("setNickname", nickname);

        	// When it has been set, the server will tell us,
        	// Then hide the nickname form and show the chat box.
        	socket.on("nicknameSet", function(){
          		nicknameForm.parentNode.removeChild(nicknameForm);

          		// Show the chat dialog box
          		document.getElementById("chatForm").style.display = "block";
        	});
          event.preventDefault();
       }

       // Send a new message to the server
       function sendChat(event){
        	socket.emit("msg", document.forms[0].text.value);
        	// Reset value
        	document.forms[0].text.value = "";
          event.preventDefault();
       }

       // Add a new element to the DOM
       function addMessageToPage (content) {
          // create a new div element
          // and give it some content
          var newDiv = document.createElement('div');
          newDiv.innerHTML = content;

          // add the newly created element and its content into the DOM
          document.body.appendChild(newDiv);
       }
    </script>
  </body>
</html>
