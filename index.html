<html>
  <head>
  	<title>Socket.io chat form</title>
  	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1">
  </head>
  <body>

    <form id="setNicknameForm" style="display:none;">
    	<input name="nickname" type="text"><br />
    	<button>Set nickname</button>
    </form>

    <form id="chatForm" style="display:none;">
    	<input name="text" type="text" size="30"><br />
    	<button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Bind event listeners
        var nicknameForm = document.getElementById("setNicknameForm");
        addEventListener(nicknameForm, 'submit', setNickname);
        
        var chatForm = document.getElementById("chatForm");
        addEventListener(chatForm, 'submit', sendChat);

        // Open a new connection with the server
        var socket = io.connect();
        var joined = false;

        // When the connection is ready, show the setNickname form
        socket.on('ready', function () {
            console.log("server ready");
            if(nicknameForm) {
          	   nicknameForm.style.display = "block";
      	    }
        });

        // On receiving new messages
        socket.on('message', function (name, message) {
            if(joined){
                // Add it to the DOM
                addMessageToPage(formatMessage(name, message));
            }
        });

        // On a new visitor joining
        socket.on('newVisitor', function (name) {
            // Add it to the DOM
            addMessageToPage("<em>" + name + " has just joined</em>");
        });

       // Listen for any chat history the user has missed
       socket.on("history", function(chatHistory){
          if(chatHistory.length > 0){
            addMessageToPage("&nbsp;&nbsp;<strong>Here's what you missed:</strong>");
            for(var i = 0; i < chatHistory.length; i++){
                // Add messages to the DOM
                addMessageToPage("&nbsp;&nbsp;" + formatMessage(chatHistory[i].nickname, chatHistory[i].message));
            }
          }
        });

       // Set the nickname on the server
       function setNickname(event){
        	var nickname = document.forms[0].nickname.value;
          // Join the chat room and provide our name
          socket.emit("joinChat", nickname);

        	// When it has been set and we've joined, the server will tell us,
        	// Then hide the nickname form and show the chat box.
        	socket.on("joined", function(){
              joined = true;
          		nicknameForm.parentNode.removeChild(nicknameForm);

          		// Show the chat dialog box
          		document.getElementById("chatForm").style.display = "block";
              // Add it to the DOM
              addMessageToPage("<em>You have now joined the chat</em>");
        	});

          event.preventDefault();
       }

       // Send a new message to the server
       function sendChat(event){
        	socket.emit("msg", document.forms[0].text.value);
        	// Reset value
        	document.forms[0].text.value = "";
          event.preventDefault();
       }

       function formatMessage(name, message){
            // Highlight the user's name
            var highlight = "#3c763d;";
            if(name === "You"){
                highlight = "#999;";
            }
            return "<strong style='color:" + highlight + "'>" + name + "</strong>: " + message;
       }

       // Add a new element to the DOM
       function addMessageToPage (content) {
          // create a new div element
          // and give it some content
          var newDiv = document.createElement('div');
          newDiv.innerHTML = content;

          // add the newly created element and its content into the DOM
          document.body.appendChild(newDiv);
       }
    </script>
  </body>
</html>
